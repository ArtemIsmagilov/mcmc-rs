name: CI

on:
  push:
    branches:
      - main

env:
  CARGO_TERM_COLOR: always

jobs:
  test:
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest]
    name: Run tests. OS ${{ matrix.os }}.
    steps:
      - name: Checkout Source
        uses: actions/checkout@v4
      - name: Install Memcached
        run: |
          if "${{ matrix.os }}" == "ubuntu-latest"; then
          apt install memcached
          else
          brew install memcached
          fi
      - name: Run servers
        run: |
          memcached -p 11211 -d
          memcached -p 11212 -A -d
          memcached -p 11213 -S -Y sasl.txt
          memcached -s /tmp/memcached.sock -d
      - name: Run tests
        run: |
          cargo check
          cargo test
